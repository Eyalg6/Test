<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<script type="application/javascript" src="js/imports/import.js"></script>
</HEAD>
<BODY>



<div id="sidebar" style="width:300px;">
	<br><br>
	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Page Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>

	<hr>
	<div id="description">Counting all dependent bugs over time</div>
	<hr>
	<div id="testMessage"></div>
	<hr>
	<div id="stats"></div>
	<hr>
	<div id="parameters" class="parameters">
	</div>
	<div id="filters" class="menu"></div>
</div>



	<div style="float:right;display: inline;">
		<a href="http://people.mozilla.com/~klahnakoski/" class="button">HOME</a>
	</div>

<div style="align:left;position:relative;float:left;width:800px;">
	<h3 id="title"></h3>

	<div>

		<div id="feature-summary" style="position: relative;min-height:30px;"></div>
		<div id="chart" class="chart" style="position: relative;height:300px;"></div>
		<!--<div id="chart_diff" class="chart" style="position: relative;height:300px;"></div>-->
		<div id="buglist" style="position: relative;width:800px"></div>
		<div id="info" style="position: relative;width:800px"></div>
	</div>
</div>
<script type="application/javascript">

importScript([
	"js/main.js",
	'js/Dimension-Bugzilla.js',
	'js/Dimension-B2G.js',
	'js/Dimension-Features.js',
	"moreJS/burndown.js"
], function(){


var thread;
var createChart = function(){
	if (thread !== undefined)
		thread.kill();
	thread = Thread.run(function*(){
		try{
			yield (__createChart());
		}catch(e){
			if (e.contains(Thread.Interrupted)) return;
			throw e;
		}//try
	});
};

var __createChart = function*(){
	$("#feature-summary").html("");
	$("#chart").html("");
	$("#chart_diff").html("");
	$("#buglist").html("");
	$("#info").html("");


	var TODAY = Date.today();

	var sampleMin = Date.newInstance(GUI.state.sampleMin);
	var sampleInterval = Duration.newInstance(GUI.state.sampleInterval);
	var sampleMax = Date.newInstance(GUI.state.sampleMax).addDay();

	var bug_ids = GUI.state.bugList.trim()=="" ? [] : GUI.state.bugList.split(",").map(function(v){return CNV.String2Integer(v.trim());});
	var timeDomain = {"type":"time", "min":sampleMin, "max":sampleMax, "interval":sampleInterval};

	var features = GUI.state.feature.getSelectedParts();
	var raw_data = null;
	if (features.length>0){
		var filter = {"or":features.select("esfilter")};
		if (bug_ids.length>0) filter.or.append({"terms":{"bug_id":bug_ids}});

		raw_data = yield(allOpenDependencies(filter, timeDomain, ["status_whiteboard"], false));

		var featureName=features.select("name").join(" and ");
		$("#title").text("Burndown for "+featureName);
	}else{
		if (bug_ids.length==0){
			$("#title").text("Must select bug number, or predefined feature");
			yield (null);
		}//endif

		Thread.run(function*(){
		///////////////////////////////////////////////////////////////////////
		// SET TITLE TO THE TOP BUG DESCRIPTION
		///////////////////////////////////////////////////////////////////////
			var r = yield(ESQuery.run({
				"from":"public_bugs",
				"select":"short_desc",
				"esfilter":{"and":[
					{"terms":{"bug_id": bug_ids}},
					Mozilla.CurrentRecords.esfilter
				]}
			}));

			$("#title").html(r.list.map(function(v){return CNV.String2HTML(v);}).join("<br>"));
		});

		raw_data = yield(allOpenDependencies({"terms":{"bug_id":bug_ids}}, timeDomain, ["status_whiteboard"], false));
	}//endif
	var currOpenBugsFilter = {"terms":{"bug_id":raw_data.cube.last().filter({"term":{"counted":"Open"}}).select("bug_id")}};  //LAST DAY WILL BE CONSIDERED CURRENT FEATURE LIST
	var currTotalBugsFilter = {"terms":{"bug_id":raw_data.cube.last().filter({"not":{"term":{"counted":"none"}}}).select("bug_id")}};  //LAST DAY WILL BE CONSIDERED CURRENT FEATURE LIST

	yield (ESQuery.loadColumns({"from":"bugs"}));

	Thread.run(function*(){
		///////////////////////////////////////////////////////////////////////
		// SUMMARY OF FEATURE
		///////////////////////////////////////////////////////////////////////
		var total = currTotalBugsFilter.terms.bug_id;
		var open = currOpenBugsFilter.terms.bug_id;
		var closed = total.subtract(open);
		//FILL TEMPLATE
		var summary=$("#feature-summary");
		var TEMPLATE = "<div>" +
				"<div id='featureTotal' class='hoverable' style='display:inline-block;margin:5px 10px 5px 10px;'>Total Bugs: {{total}}</div>"+
				"<div id='featureClosed' class='hoverable' style='display:inline-block;margin:5px 10px 5px 10px;'>Closed: {{closed}} ({{closed_percent}}%)</div>"+
				"<div id='featureOpen' class='hoverable' style='display:inline-block;margin:5px 10px 5px 10px;'>Open Bugs: {{open}}</div>" +
				"</div";
		summary.html(TEMPLATE.replaceVars({
			"total":total.length,
			"open":open.length,
			"closed":closed.length,
			"closed_percent":aMath.round((closed.length)/total.length*100)
		}));

		//ADD BUG CLICKERS
		$("#featureTotal").click(function(){
			Bugzilla.showBugs(total);
		});
		$("#featureClosed").click(function(){
			Bugzilla.showBugs(closed);
		});
		$("#featureOpen").click(function(){
			Bugzilla.showBugs(open);
		});

	});

	Thread.run(function*(){
		////////////////////////////////////////////////////////////////////////////
		// CURRENT BUGS LIST
		////////////////////////////////////////////////////////////////////////////

		var bugs = yield (ESQuery.run({
			"from":"public_bugs",
			"select":[
				"bug_id",
				"short_desc",
				"assigned_to",
				"bug_status",
				"resolution",
				"status_whiteboard"
			],
			"esfilter":{"and":[
				Mozilla.BugStatus.Open.esfilter,
				Mozilla.CurrentRecords.esfilter,
				currOpenBugsFilter
			]}
		}));

		var details = yield (Qb.calc2List({
			"from":bugs,
			"select":[
				{"name":"bug_id", "value":"bug_id"},
				{"name":"Summary", "value":"short_desc"},
				{"name":"Owner", "value":"assigned_to"},
				{"name":"Status", "value":"bug_status + (resolution ? ' - '+resolution : '')"},
				{"name":"Estimate", "value":"nvl(ScrumBugs.parse(status_whiteboard).points, 'missing')"}
			],
			"sort":["Status", "bug_id"]
		}));

		$("#buglist").html(bugDetails(details.list));
	});

	var chart= yield(Q({
		"from": raw_data,
		"select":{"name":"num", "value":'nvl(ScrumBugs.parse(status_whiteboard).points, 1)-0', "aggregate":"sum"},
		"edges":[
			{"name": "status", "value": "counted", "domain": {"type": "set", "key":"value", "partitions": [
				{"name": "Open", "value": "Open"},
				{"name": "Closed", "value": "Closed"},
				{"name": "none", "value":"none"}
			]}},
			{"name":"date",
				"value":"date",
				"allowNulls":false,
				"domain":timeDomain
			}
		]
	}));

	//CONVERT EDGE TO ATTRIBUTES
	var flat = yield(Q({
		"from":chart,
		"select":[
			{"name":"Open", "value":"status.name=='Open' ? num : null", "aggregate":"sum", "default":0},
			{"name":"Total", "value":"status.name!='none' ? num : null", "aggregate":"sum", "default":0}
		],
		"edges":[
			{"name":"date", "value":"date",
				"allowNulls":false,
				"domain":{"type":"time", "min":sampleMin, "max":sampleMax, "interval":sampleInterval, "value":"value"}
			}
		]
	}));
	var tempTimeDomain=flat.edges[0].domain;

	//SHOW FUTURE VALUES AS NULLS
	flat.cube.forall(function(v, i){
		if (tempTimeDomain.partitions[i].min > TODAY){
			flat.cube[i]=Map.zip(mapAllKey(v, function(k, v){
				return [k, null];
			}));
		}//endif
	});


	a = Log.action("Make chart", true);
	aChart.show({
		"id":"chart",
		"sheetDiv":"info",
		"type":"line",
		"stacked":false,
		"cube":flat,
		"xAxisSize":50,
		extensionPoints: {
		    dot_shapeRadius: 3,
            dot_shape:"circle",
			line_lineWidth: 3
		},
		"clickAction":function(series, x, d){
			var series2filter = {
				"Open": {"term": {"counted": series}},
				"Total": {"not": {"term": {"counted": "none"}}}
			};

			Thread.run(function*(){
				var buglist=(yield (Q({
					"from":raw_data,
					"select":{"value":"bug_id", "aggregate":"minimum"},
					"edges":[
						{"name":"unique", "value":"bug_id"}
					],
					"esfilter":{"and":[
						series2filter[series],
						{"term":{"date":x}}
					]}
				})));

				Bugzilla.showBugs([].union(buglist.cube));
			});
		}//click
	});
	Log.actionDone(a);

};


$(document).ready(function(){
	GUI.setup(createChart, [
		{"id":"bugList", "name":"Tracking Bug(s)", "type":"text", "default":null},
		{"id":"sampleMin", "name":"Start Date", "type":"time", "default":Date.eod().add("-6week")},
		{"id":"sampleMax", "name":"End Date", "type":"time", "default":Date.today().ceilingWeek()},
		{"id":"sampleInterval", "name":"Interval", "type":"duration", "default":"day"},
		{"id": "feature", "name": "Feature", "type": PartitionFilter.newInstance({
			"id": "features",
			"name": "All Features",
			"dimension": Mozilla.Feature,
			"onlyOne": false,
			"expandAll": true,
			"treeDepth":0
		})}
		],
			[
				"sampleMin=Date.newInstance(sampleMin).floor(Duration.newInstance(sampleInterval)).format('yyyy-MM-dd')",
				"sampleMax=Date.newInstance(sampleMax).addDay(1).floor(Duration.newInstance(sampleInterval)).addDay(-1).format('yyyy-MM-dd')"
			],
		"bugs",
		false
	);

//	GUI.productFilter = ["B2G 1.0.0 (TEF)"];

});

});
</script>



</BODY>
</HTML>

